{% extends 'dashboard/admin_base.html' %}

{% block title %}Manage Requests{% endblock %}
{% block page_title %}Manage Requests{% endblock %}

{% block content_admin %}

<h3 class="section-title">üè• Hospital Requests</h3>
<table class="styled-table">
    <thead>
        <tr>
            <th>Hospital</th>
            <th>Blood Group</th>
            <th>Units</th>
            <th>Urgency</th>
            <th>Required Date</th>
            <th>Status</th>
            <th>Requested On</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for req in hospital_requests %}
        <tr>
            <td>{{ req.hospital.username }}</td>
            <td>{{ req.blood_group }}</td>
            <td>{{ req.units }}</td>
            <td class="{% if req.urgency == 'High' %}urgency-high{% elif req.urgency == 'Medium' %}urgency-medium{% else %}urgency-low{% endif %}">
                {{ req.urgency }}
            </td>
            <td>{{ req.required_date }}</td>

            <!-- ‚úÖ UPDATED STATUS LOGIC -->
            <td>
                {% if req.status == 'Approved' and req.required_date == today %}
                    <span class="badge completed">Completed</span>

                {% elif req.required_date < today and req.status == 'Pending' %}
                    <span class="badge expired">Expired</span>

                {% else %}
                    <span class="badge 
                        {% if req.status == 'Approved' %}
                            approved
                        {% elif req.status == 'Pending' %}
                            pending
                        {% else %}
                            rejected
                        {% endif %}
                    ">
                        {{ req.status }}
                    </span>
                {% endif %}
            </td>

            <td>{{ req.created_at|date:"Y-m-d H:i" }}</td>

            <td>
                {% if req.status == 'Pending' %}
                    {% if req.required_date < today %}
                        <em>Expired</em>
                    {% else %}
                        <a href="{% url 'approve_hospital_request' req.id %}" class="btn-approve">Approve</a>
                        <a href="{% url 'reject_hospital_request' req.id %}" class="btn-reject">Reject</a>
                    {% endif %}
                {% else %}
                    <em>------</em>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center">No hospital requests found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<h3 class="section-title">ü©∏ Donor Requests</h3>
<table class="styled-table">
    <thead>
        <tr>
            <th>Donor</th>
            <th>Blood Group</th>
            <th>Status</th>
            <th>Requested On</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for req in donor_requests %}
        <tr>
            <td>{{ req.donor.username }}</td>
            <td>{{ req.blood_group }}</td>

            <td>
                <span class="badge {% if req.status == 'Approved' %}approved{% elif req.status == 'Pending' %}pending{% else %}rejected{% endif %}">
                    {{ req.status }}
                </span>
            </td>

            <td>{{ req.created_at|date:"Y-m-d H:i" }}</td>

            <td>
                {% if req.status == 'Pending' %}
                    <a href="{% url 'approve_donor_request' req.id %}" class="btn-approve">Approve</a>
                    <a href="{% url 'reject_donor_request' req.id %}" class="btn-reject">Reject</a>
                {% else %}
                    <em>------</em>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center">No donor requests found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<h3 class="section-title">üíâ Recipient Requests</h3>
<table class="styled-table">
    <thead>
        <tr>
            <th>Recipient</th>
            <th>Blood Group</th>
            <th>Units</th>
            <th>Required Date</th>
            <th>Status</th>
            <th>Requested On</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for req in recipient_requests %}
        <tr>
            <td>{{ req.recipient.username }}</td>
            <td>{{ req.blood_group }}</td>
            <td>{{ req.units }}</td>
            <td>{{ req.required_date }}</td>

            <!-- ‚úÖ UPDATED STATUS LOGIC -->
            <td>
                {% if req.status == 'Approved' and req.required_date == today %}
                    <span class="badge completed">Completed</span>

                {% elif req.required_date < today and req.status == 'Pending' %}
                    <span class="badge expired">Expired</span>

                {% else %}
                    <span class="badge 
                        {% if req.status == 'Approved' %}
                            approved
                        {% elif req.status == 'Pending' %}
                            pending
                        {% else %}
                            rejected
                        {% endif %}
                    ">
                        {{ req.status }}
                    </span>
                {% endif %}
            </td>

            <td>{{ req.created_at|date:"Y-m-d H:i" }}</td>

            <td>
                {% if req.status == 'Pending' %}
                    {% if req.required_date < today %}
                        <em>Expired</em>
                    {% else %}
                        <a href="{% url 'approve_recipient_request' req.id %}" class="btn-approve">Approve</a>
                        <a href="{% url 'reject_recipient_request' req.id %}" class="btn-reject">Reject</a>
                    {% endif %}
                {% else %}
                    <em>------</em>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-center">No recipient requests found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<style>
.section-title {
    color: #8B0000;
    margin-bottom: 10px;
    margin-top: 20px;
    font-size: 18px;
}

.styled-table thead th {
    background-color: #8B0000;
    color: #fff;
    text-transform: uppercase;
    font-size: 14px;
}
.styled-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}
.styled-table tbody tr:nth-child(odd) {
    background-color: #ffffff;
}
.styled-table tbody tr:hover {
    background-color: #ffe6e6;
}

.badge {
    padding: 5px 10px;
    border-radius: 5px;
    font-weight: 600;
    color: white;
    font-size: 13px;
}
.badge.approved {
    background-color: #28a745;
}
.badge.pending {
    background-color: #ffc107;
    color: #333;
}
.badge.rejected {
    background-color: #dc3545;
}

/* üîπ New Status Colors */
.badge.expired {
    background-color: #6c757d;
    color: white;
}
.badge.completed {
    background-color: #0d6efd;
    color: white;
}

/* Urgency Colors */
.urgency-high { color: #f51d32; font-weight: 750; }
.urgency-medium { color: #ffc107; font-weight: 600; }
.urgency-low { color: #28a745; font-weight: 600; }
</style>

{% endblock %}
